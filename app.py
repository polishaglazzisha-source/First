# -*- coding: utf-8 -*-
# –ê–Ω–∫–µ—Ç–∞ –®–∫–æ–ª—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –ù–ò–£ –í–®–≠. –ò—Å—Ç–æ—á–Ω–∏–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî –≤–∞—à —Ç–µ–∫—Å—Ç.
# –ó–∞–ø–∏—Å—å –≤ Google Sheets. –í–∞–ª–∏–¥–∞—Ü–∏–∏ min/max. –ü–æ–¥—Å—á—ë—Ç—ã: –±–ª–æ–∫ 2, —Å–≤–æ–¥–∫–∏ –ø–æ –ø.1 –∏ –ø.3.
# –°—Ç–∏–ª—å: –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏.

import os, re, time, uuid
from datetime import datetime
import streamlit as st
import gspread
from google.oauth2.service_account import Credentials

st.set_page_config(page_title='–ê–Ω–∫–µ—Ç–∞ (–®–∫–æ–ª–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –ù–ò–£ –í–®–≠)', page_icon='üìù', layout='centered')

# --------------------
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Google Sheets (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
# --------------------
SCOPES = ['https://www.googleapis.com/auth/spreadsheets']

SERVICE_INFO = None
SHEET_ID = None

# 1) —á–∏—Ç–∞–µ–º gcp_service_account
try:
    SERVICE_INFO = dict(st.secrets['gcp_service_account'])
    secrets_gcp_loaded = True
except Exception:
    secrets_gcp_loaded = False

# 2) –ø—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å google_sheet_id –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç
try:
    SHEET_ID = st.secrets.get('google_sheet_id', None)
    if not SHEET_ID and 'gcp_service_account' in st.secrets:
        SHEET_ID = st.secrets['gcp_service_account'].get('google_sheet_id', None)
    if not SHEET_ID and 'app' in st.secrets:
        SHEET_ID = st.secrets['app'].get('google_sheet_id', None)
except Exception:
    SHEET_ID = None

# 3) fallback: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if not SHEET_ID:
    SHEET_ID = os.getenv('GOOGLE_SHEET_ID', None)

# –≤—ã–≤–æ–¥–∏–º —Ä–æ–≤–Ω–æ —Ç–æ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º
st.sidebar.write('secrets_gcp_loaded:', secrets_gcp_loaded)
st.sidebar.write('sheet_id_value_present:', bool(SHEET_ID))

# 4) —Å—Ç–æ–ø, –µ—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç
if not secrets_gcp_loaded or not SHEET_ID:
    if not secrets_gcp_loaded and not SHEET_ID:
        st.error('–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏ [gcp_service_account], –∏ google_sheet_id.')
    elif not secrets_gcp_loaded:
        st.error('–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–µ–∫—Ü–∏—è [gcp_service_account].')
    else:
        st.error('–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á google_sheet_id.')
    st.stop()

# 5) –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
creds = Credentials.from_service_account_info(SERVICE_INFO, scopes=SCOPES)
gc = gspread.authorize(creds)
sh = gc.open_by_key(SHEET_ID)
ws = sh.sheet1

# --------------------
# –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏/—Ç–µ–∫—Å—Ç—ã
# --------------------
q1_options = [
    '–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–∞–≤–∞–º–∏',
    '–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª',
    '–ï–¥–∏–Ω—Å—Ç–≤–æ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ –≤—Å–µ—Ö –ª—é–¥–µ–π',
    '–ó–¥–æ—Ä–æ–≤—å–µ',
    '–ö–∞—Ä—å–µ—Ä–∞',
    '–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç',
    '–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç–∞—Ç–æ–∫',
    '–û–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ',
    '–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω—É–∂–¥—ã –≤ —á–µ–º-—Ç–æ, —á—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏',
    '–ü–æ–¥–æ–±—Ä–∞—Ç—å —É–≤–ª–µ—á–µ–Ω–∏–µ, —Å–æ–≥–ª–∞—Å—É—é—â–µ–µ—Å—è —Å –º–æ–µ–π –Ω–∞—Ç—É—Ä–æ–π',
    '–°–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ',
    '–°–≤–æ–±–æ–¥–∞',
    '–°–µ–º–µ–π–Ω–æ–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ',
    '–°–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞—Ç—å—Å—è –≤ —Å–≤–æ–µ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏',
    '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –≤ –æ–±—â–µ—Å—Ç–≤–µ',
    '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∏–ª –≤ –∫—Ä–∏–∑–∏—Å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö',
    '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å',
    '–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –±–æ–ª–µ–µ –≥—É–º–∞–Ω–Ω–æ–≥–æ –∏ —Ç–µ—Ä–ø–∏–º–æ–≥–æ –æ–±—â–µ—Å—Ç–≤–∞',
    '–£–≤–∞–∂–µ–Ω–∏–µ —Å—Ä–µ–¥–∏ –∑–Ω–∞–∫–æ–º—ã—Ö',
    '–•–æ—Ä–æ—à–∞—è, –ø—Ä–µ—Å—Ç–∏–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞',
    '–®–∏—Ä–æ—Ç–∞ –≤–∑–≥–ª—è–¥–æ–≤'
]

b2_text = {
    1: '–ß–∞—Å—Ç–æ –ª–∏ –≤—ã –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç–µ —Ç—è–≥—É –∫ –Ω–æ–≤—ã–º –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º, –∫ —Ç–æ–º—É, —á—Ç–æ–±—ã –æ—Ç–≤–ª–µ—á—å—Å—è, –∏—Å–ø—ã—Ç—ã–≤–∞—Ç—å —Å–∏–ª—å–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è?',
    2: '–°—á–∏—Ç–∞–µ—Ç–µ –ª–∏ –≤—ã —Å–µ–±—è –±–µ–∑–∑–∞–±–æ—Ç–Ω—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º?',
    3: '–û–±–¥—É–º—ã–≤–∞–µ—Ç–µ –ª–∏ –≤—ã —Å–≤–æ–∏ –¥–µ–ª–∞ –Ω–µ —Å–ø–µ—à–∞ –∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –ª–∏ –ø–æ–¥–æ–∂–¥–∞—Ç—å, –ø—Ä–µ–∂–¥–µ —á–µ–º –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å?',
    4: '–í—Å–µ–≥–¥–∞ –ª–∏ –≤—ã —Å–¥–µ—Ä–∂–∏–≤–∞–µ—Ç–µ —Å–≤–æ–∏ –æ–±–µ—â–∞–Ω–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –≤–∞–º –Ω–µ–≤—ã–≥–æ–¥–Ω–æ?',
    5: '–ë—ã—Å—Ç—Ä–æ –ª–∏ –≤—ã –æ–±—ã—á–Ω–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç–µ –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ, –Ω–µ —Ç—Ä–∞—Ç–∏—Ç–µ –ª–∏ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ–±–¥—É–º—ã–≤–∞–Ω–∏–µ?',
    6: '–í–µ—Ä–Ω–æ –ª–∏, —á—Ç–æ –Ω–∞ —Å–ø–æ—Ä –≤—ã —Å–ø–æ—Å–æ–±–Ω—ã —Ä–µ—à–∏—Ç—å—Å—è –Ω–∞ –≤—Å—ë?',
    7: '–ë—ã–≤–∞–µ—Ç –ª–∏ –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å, —á—Ç–æ, —Ä–∞–∑–æ–∑–ª–∏–≤—à–∏—Å—å, –≤—ã –≤—ã—Ö–æ–¥–∏—Ç–µ –∏–∑ —Å–µ–±—è?',
    8: '–ß–∞—Å—Ç–æ –ª–∏ –±—ã–≤–∞–µ—Ç, —á—Ç–æ –≤—ã –¥–µ–π—Å—Ç–≤—É–µ—Ç–µ –Ω–µ–æ–±–¥—É–º–∞–Ω–Ω–æ, –ø–æ–¥ –≤–ª–∏—è–Ω–∏–µ–º –º–æ–º–µ–Ω—Ç–∞?',
    9: '–õ—é–±–∏—Ç–µ –ª–∏ –≤—ã —á–∞—Å—Ç–æ –±—ã–≤–∞—Ç—å –≤ –∫–æ–º–ø–∞–Ω–∏–∏ –∑–Ω–∞–∫–æ–º—ã—Ö –∏ –¥—Ä—É–∑–µ–π?',
    10: '–ë—ã–≤–∞—é—Ç –ª–∏ –∏–Ω–æ–≥–¥–∞ —É –≤–∞—Å —Ç–∞–∫–∏–µ –º—ã—Å–ª–∏, –∫–æ—Ç–æ—Ä—ã–º–∏ –≤–∞–º –Ω–µ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –ª—é–¥—å–º–∏?',
    11: '–°—Ç–∞—Ä–∞–µ—Ç–µ—Å—å –ª–∏ –≤—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫—Ä—É–≥ —Å–≤–æ–∏—Ö –∑–Ω–∞–∫–æ–º—ã—Ö –Ω–µ–±–æ–ª—å—à–∏–º —á–∏—Å–ª–æ–º —Å–∞–º—ã—Ö –±–ª–∏–∑–∫–∏—Ö –¥—Ä—É–∑–µ–π?',
    12: '–ö–æ–≥–¥–∞ –Ω–∞ –≤–∞—Å –∫—Ä–∏—á–∞—Ç, –æ—Ç–≤–µ—á–∞–µ—Ç–µ –ª–∏ –≤—ã —Ç–µ–º –∂–µ?',
    13: '–°—á–∏—Ç–∞–µ—Ç–µ –ª–∏ –≤—ã –≤—Å–µ —Å–≤–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏ —Ö–æ—Ä–æ—à–∏–º–∏?',
    14: '–°–ø–æ—Å–æ–±–Ω—ã –ª–∏ –≤—ã –∏–Ω–æ–≥–¥–∞ –¥–∞—Ç—å –≤–æ–ª—é —Å–≤–æ–∏–º —á—É–≤—Å—Ç–≤–∞–º –∏ –±–µ–∑–∑–∞–±–æ—Ç–Ω–æ —Ä–∞–∑–≤–ª–µ—á—å—Å—è —Å –≤–µ—Å–µ–ª–æ–π –∫–æ–º–ø–∞–Ω–∏–µ–π?',
    15: '–°–ª—ã–≤–µ—Ç–µ –ª–∏ –≤—ã –∑–∞ —á–µ–ª–æ–≤–µ–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã–º –∏ –≤–µ—Å—ë–ª—ã–º?',
    16: '–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã —Å–µ–±—è –Ω–µ—Å–ø–æ–∫–æ–π–Ω–æ, –Ω–∞—Ö–æ–¥—è—Å—å –≤ –±–æ–ª—å—à–æ–π –∫–æ–º–ø–∞–Ω–∏–∏?',
    17: '–ë—ã–≤–∞–µ—Ç –ª–∏, —á—Ç–æ –≤—ã –ø–µ—Ä–µ–¥–∞—ë—Ç–µ —Å–ª—É—Ö–∏?',
    18: '–ù—Ä–∞–≤–∏—Ç—Å—è –ª–∏ –≤–∞–º —Ä–∞–±–æ—Ç–∞, —Ç—Ä–µ–±—É—é—â–∞—è —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω–∏—è?',
    19: '–í—Å–µ–≥–¥–∞ –ª–∏ –≤—ã –≥–æ–≤–æ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–¥—É?',
    20: '–ë—ã–≤–∞–µ—Ç –ª–∏ –≤–∞–º –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –∫–æ–º–ø–∞–Ω–∏–∏, –≥–¥–µ –≤—Å–µ –ø–æ–¥—à—É—á–∏–≤–∞—é—Ç –¥—Ä—É–≥ –Ω–∞–¥ –¥—Ä—É–≥–æ–º?',
    21: '–í–µ—Ä–Ω–æ –ª–∏, —á—Ç–æ –≤—ã –Ω–µ—Ç–æ—Ä–æ–ø–ª–∏–≤—ã –≤ –¥–≤–∏–∂–µ–Ω–∏—è—Ö –∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ–¥–ª–∏—Ç–µ–ª—å–Ω—ã?',
    22: '–û–ø–∞–∑–¥—ã–≤–∞–ª–∏ –ª–∏ –≤—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –Ω–∞ —Ä–∞–±–æ—Ç—É –∏–ª–∏ –Ω–∞ –≤—Å—Ç—Ä–µ—á—É —Å –∫–µ–º-–ª–∏–±–æ?'
}

q3_options = [
    '–í –∂–∏–∑–Ω–∏ –∏–≥—Ä–∞—é —Ç–∞–∫ –º–Ω–æ–≥–æ —Ä–æ–ª–µ–π –Ω–∞ —Ä–∞–±–æ—Ç–µ, –¥–æ–º–∞ –∏ –≤ –æ–±—â–µ—Å—Ç–≤–µ, —á—Ç–æ –±–æ—é—Å—å –ø–æ—Ç–µ—Ä–∏ —Å–µ–±—è',
    '–í –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ —É–±–µ–∂–¥–∞—é —Å–µ–±—è –∏ –¥—Ä—É–≥–∏—Ö, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Å—Ç–æ–∏—Ç ¬´–≤—ã–µ–¥–µ–Ω–Ω–æ–≥–æ —è–π—Ü–∞¬ª',
    '–í –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏ –±–æ–ª—å—à–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —É—Å—Ç–∞–ª–æ—Å—Ç—å, –Ω–µ—Ç –æ—â—É—â–µ–Ω–∏—è –æ—Ç–¥—ã—Ö–∞',
    '–í –Ω–µ—É–¥–∞—á–µ –≥–æ–≤–æ—Ä—é —Å–µ–±–µ: ¬´–ù—É–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑¬ª',
    '–í —Å—Å–æ—Ä–µ –ª–µ–≥–∫–æ –≤—ã—Ä–∞–∂–∞—é —á—É–≤—Å—Ç–≤–∞, –æ–±–æ–∑–Ω–∞—á–∞—é –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏, –≤—ã—Å–ª—É—à–∏–≤–∞—é –¥—Ä—É–≥–∏—Ö',
    '–í–æ–∑–Ω–∏–∫–∞—é—â–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–æ–¥–æ–ª–µ–≤–∞—Ç—å',
    '–î—É–º–∞—é, —á—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–µ–æ–¥–æ–ª–µ—é –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –∏ –¥–æ–±—å—é—Å—å —Å–≤–æ–µ–≥–æ',
    '–ï—Å–ª–∏ –æ–±–∏–¥–µ–ª–∏ ‚Äî —Å–∏–ª—å–Ω–æ –ø–µ—Ä–µ–∂–∏–≤–∞—é –∏ –±–µ—Å–ø–æ–∫–æ—é—Å—å',
    '–ï—Å–ª–∏ –Ω–µ —É–¥–∞—ë—Ç—Å—è ‚Äî —É–ø–æ—Ä—Å—Ç–≤—É—é –∏ –ø—Ä–∏–ª–∞–≥–∞—é –≤—Å–µ —É—Å–∏–ª–∏—è',
    '–ï—Å–ª–∏ –≤—Å–ø—ã–ª–∏–ª ‚Äî –≤–µ–¥—É —Å–µ–±—è –æ—Ç—Å—Ç—Ä–∞–Ω—ë–Ω–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π',
    '–û—Ç–∫–ª–∞–¥—ã–≤–∞—é —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –Ω–∞–¥–µ–∂–¥–µ, —á—Ç–æ —Ä–µ—à–∏—Ç—Å—è —Å–∞–º–∞',
    '–ö–æ–Ω—Ñ–ª–∏–∫—Ç —É–≥–Ω–µ—Ç–∞–µ—Ç ‚Äî —É—Ö–æ–∂—É –≤ –¥—Ä—É–≥–∏–µ –¥–µ–ª–∞/–∂–¥—É, —á—Ç–æ –≤—Ä–µ–º—è —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç —Ç–æ—á–∫–∏',
    '–ù–µ—É–¥–∞—á–∏ –ø–æ–±—É–∂–¥–∞—é—Ç –∫ –µ—â—ë –±–æ–ª—å—à–∏–º —É—Å–∏–ª–∏—è–º',
    '–ù–µ—É–¥–∞—á–∏ –ø–æ–±—É–∂–¥–∞—é—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è, —á—Ç–æ–±—ã –∑–∞–±—ã—Ç—å',
    '–ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑–±–µ–≥–∞—é —Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ —Å—Å–æ—Ä–∞—Ö',
    '–ü–æ—Ä–∞–∂–µ–Ω–∏—è –ø–æ–±—É–∂–¥–∞—é—Ç –≤–æ –º–Ω–µ –Ω–æ–≤—ã–µ —Å–∏–ª—ã',
    '–ü–æ—Å–ª–µ —Å—Å–æ—Ä—ã —á—É–≤—Å—Ç–≤—É—é –≤–∏–Ω—É –∏ —Å—Ç–∞—Ä–∞—é—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è',
    '–°–∏—Ç—É–∞—Ü–∏–∏ —Å—Ç—Ä–µ—Å—Å–∞ –ø—Ä–∏–Ω–∏–º–∞—é –±–ª–∏–∑–∫–æ –∫ —Å–µ—Ä–¥—Ü—É –∏ —Å–∏–ª—å–Ω–æ –ø–µ—Ä–µ–∂–∏–≤–∞—é',
    '–°—Ç–æ–ª–∫–Ω—É–≤—à–∏—Å—å —Å –ø—Ä–æ–±–ª–µ–º–æ–π, –∏—â—É –ø–æ–¥–¥–µ—Ä–∂–∫—É —É –æ–∫—Ä—É–∂–∞—é—â–∏—Ö',
    '–°—Ç—Ä–µ—Å—Å –≤—ã–º–∞—Ç—ã–≤–∞–µ—Ç ‚Äî –±–µ—Ä–µ–≥—É —ç–Ω–µ—Ä–≥–∏—é, –Ω–∞–¥–µ—é—Å—å, —á—Ç–æ –≤—Å—ë —Ä–∞—Å—Å–æ—Å—ë—Ç—Å—è',
    '–¢—Ä–µ–≤–æ–≥–∞ –ø—Ä–∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏, —Ç—Ä—É–¥–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —ç–º–æ—Ü–∏–∏'
]

q4_options = [
    '–ì–æ–≤–æ—Ä–∏–ª —Å –∫–µ–º-–ª–∏–±–æ, –∫—Ç–æ –º–æ–≥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ–º–æ—á—å',
    '–î—É–º–∞–ª –æ —Ç–æ–º, –∫–∞–∫ –±—ã –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª —á–µ–ª–æ–≤–µ–∫, –∫–æ—Ç–æ—Ä—ã–º —è –≤–æ—Å—Ö–∏—â–∞—é—Å—å',
    '–ó–Ω–∞–ª, —á—Ç–æ –Ω–∞–¥–æ –¥–µ–ª–∞—Ç—å, –∏ —É–¥–≤–∞–∏–≤–∞–ª —É—Å–∏–ª–∏—è',
    '–ú–æ–ª–∏–ª—Å—è',
    '–ù–∞–±–∏—Ä–∞–ª—Å—è –æ–ø—ã—Ç–∞ –≤ –¥–∞–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏',
    '–ù–∞—Ö–æ–¥–∏–ª –Ω–æ–≤—É—é –≤–µ—Ä—É –≤–æ —á—Ç–æ-—Ç–æ',
    '–û—Ç–∫–∞–∑—ã–≤–∞–ª—Å—è –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å —ç—Ç–æ —Å–ª–∏—à–∫–æ–º —Å–µ—Ä—å—ë–∑–Ω–æ',
    '–ü–æ–ª—å–∑–æ–≤–∞–ª—Å—è –ø—Ä–æ—à–ª—ã–º –æ–ø—ã—Ç–æ–º ‚Äì –º–Ω–µ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å —É–∂–µ –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Ç–∞–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏',
    '–ü—ã—Ç–∞–ª—Å—è —É–ª—É—á—à–∏—Ç—å —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –µ–¥–æ–π, –≤—ã–ø–∏–≤–∫–æ–π, –∫—É—Ä–µ–Ω–∏–µ–º –∏–ª–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞–º–∏',
    '–°–ø—Ä–∞—à–∏–≤–∞–ª —Å–æ–≤–µ—Ç–∞ —É —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞ –∏–ª–∏ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã—Ö —É–≤–∞–∂–∞–ª',
    '–°—Ç–∞—Ä–∞–ª—Å—è –¥–∞—Ç—å –∫–∞–∫–æ–π-—Ç–æ –≤—ã—Ö–æ–¥ —Å–≤–æ–∏–º —á—É–≤—Å—Ç–≤–∞–º',
    '–°—Ç–∞—Ä–∞–ª—Å—è, —á—Ç–æ–±—ã –º–æ–∏ —ç–º–æ—Ü–∏–∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –º–µ—à–∞–ª–∏ –º–Ω–µ –≤ –¥—Ä—É–≥–∏—Ö –¥–µ–ª–∞—Ö',
    '–°—Ç–æ—è–ª –Ω–∞ —Å–≤–æ—ë–º –∏ –±–æ—Ä–æ–ª—Å—è –∑–∞ —Ç–æ, —á–µ–≥–æ —Ö–æ—Ç–µ–ª',
    '–ß—Ç–æ-—Ç–æ –º–µ–Ω—è–ª –≤ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏ —Ç–∞–∫, —á—Ç–æ –≤—Å—ë —É–ª–∞–∂–∏–≤–∞–ª–æ—Å—å',
    '–ß—Ç–æ-—Ç–æ –º–µ–Ω—è–ª –≤ —Å–µ–±–µ',
    '–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç'
]

q5_items = [
    '–£—á–∞—Å—Ç–≤—É—é –≤ –º–æ–ª–æ–¥–µ–∂–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ä—É–º–∞—Ö',
    '–£—á–∞—Å—Ç–≤—É—é –≤ –¥–æ–±—Ä–æ–≤–æ–ª—å—á–µ—Å–∫–æ–π (–≤–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–æ–π) –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏',
    '–Ø–≤–ª—è—é—Å—å —á–ª–µ–Ω–æ–º —Å–æ—Ü–∏–∞–ª—å–Ω–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ù–ö–û, –º–æ–ª–æ–¥–µ–∂–Ω—ã—Ö –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–π',
    '–£—á–∞—Å—Ç–≤—É—é –≤ –≤—ã–±–æ—Ä–∞—Ö',
    '–£—á–∞—Å—Ç–≤—É—é –≤ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–ª–æ–¥–µ–∂–Ω–æ–≥–æ –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–∞ / –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞',
    '–£—á–∞—Å—Ç–≤—É—é –≤ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –ø–∞—Ä—Ç–∏–∏',
    '–£—á–∞—Å—Ç–≤—É—é –≤ –≤–æ–∂–∞—Ç—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—Ç—Ä—è–¥—ã)',
    '–†–µ–∞–ª–∏–∑—É—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç',
    '–£—á–∞—Å—Ç–≤—É—é –≤ –ø–æ–∏—Å–∫–æ–≤–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤–æ–µ–Ω–Ω–æ-–ø–∞—Ç—Ä–∏–æ—Ç–∏—á–µ—Å–∫–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å)',
    '–£—á–∞—Å—Ç–≤—É—é –≤ –Ω–∞—É—á–Ω—ã—Ö –∏/–∏–ª–∏ —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –∫–æ–ª–ª–µ–∫—Ç–∏–≤–∞—Ö',
    '–ó–∞–Ω–∏–º–∞—é—Å—å —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–º/—É—á–µ–Ω–∏—á–µ—Å–∫–∏–º —Å–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º',
    '–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç'
]
FREQ3 = ['–†–µ–≥—É–ª—è—Ä–Ω–æ', '–ò–Ω–æ–≥–¥–∞', '–ù–∏–∫–æ–≥–¥–∞']
MAP_Q5 = {'–†–µ–≥—É–ª—è—Ä–Ω–æ': 2, '–ò–Ω–æ–≥–¥–∞': 1, '–ù–∏–∫–æ–≥–¥–∞': 0}

q6_items = [
    '–í—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ-–∑–Ω–∞—á–∏–º—ã–º –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–æ–±–ª–µ–º–∞–º –≤ –±–ª–æ–≥–∞—Ö, —Ñ–æ—Ä—É–º–∞—Ö, —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö, –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –Ω–∞ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö',
    '–ü–æ—Å–µ—â–µ–Ω–∏–µ —Å–∞–π—Ç–æ–≤ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä—Ç–∏–π, –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö (–Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö) –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π',
    '–ü–æ—Å–µ—â–µ–Ω–∏–µ —Å–∞–π—Ç–æ–≤/—Å—Ç—Ä–∞–Ω–∏—Ü –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–µ—è—Ç–µ–ª–µ–π, –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤',
    '–£—á–∞—Å—Ç–∏–µ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–æ–ø—Ä–æ—Å–∞—Ö –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è—Ö',
    '–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–µ—Ç–∏—Ü–∏–π, –æ–±—Ä–∞—â–µ–Ω–∏–π',
    '–†–∞–∑–º–µ—â–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Å—Ç–Ω—ã—Ö (–ª–æ–∫–∞–ª—å–Ω—ã—Ö) –∑–Ω–∞—á–∏–º—ã—Ö –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö, —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö –Ω–∞ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö, –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö',
    '–†–∞–∑–º–µ—â–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–±—â–µ–Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–∏–º—ã—Ö –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö, —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö –Ω–∞ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö, –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö',
    '–£—á–∞—Å—Ç–∏–µ –≤ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–µ / –ø—É–±–ª–∏—á–Ω–æ–π –æ—Ü–µ–Ω–∫–µ –∑–∞–∫–æ–Ω–æ–ø—Ä–æ–µ–∫—Ç–æ–≤',
    '–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ / –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä—Ç–∏–π',
    '–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ / –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö (–Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö) –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π',
    '–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ / –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ—è—Ç–µ–ª–µ–π',
    '–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ / –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–µ—è—Ç–µ–ª–µ–π',
    '–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Å—Ç–Ω—ã—Ö (–ª–æ–∫–∞–ª—å–Ω—ã—Ö) –∑–Ω–∞—á–∏–º—ã—Ö –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö, —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö –Ω–∞ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö, –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö',
    '–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–±—â–µ–Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–∏–º—ã—Ö –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö, —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö –Ω–∞ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö, –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö',
    '–ñ–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (–∑–∞–ø–∏—Å—å –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤, —Å—ä–µ–º–∫–∞ —Ñ–∏–ª—å–º–æ–≤ –∏ —Ç.–¥.)',
    '–ñ–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –∏ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤',
    '–ñ–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ –Ω–∞ –∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –∏–Ω—ã–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏',
    '–ù–∏—á–µ–≥–æ –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ',
    '–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç'
]

# --------------------
# –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ (—à–∞–ø–∫–∞)
# --------------------
HEADERS = [
    'response_id', 'ts', 'duration_sec', 'email',
    'q1_values', 'q1_adaptation_cnt', 'q1_socialization_cnt', 'q1_individualization_cnt',
    'b2_extro_score', 'b2_extro_class', 'b2_otro_score', 'b2_otro_class',
    'q3_values', 'q3_reliable_cnt', 'q3_anxious_cnt', 'q3_avoidant_cnt',
    'q4_values', 'q4_free',
    # –ø.5 ‚Äî —á–∞—Å—Ç–æ—Ç—ã –∏ –∫–æ–¥
    *[f'q5_{name}' for name in q5_items],
    'q5_free_text',
    *[f'q5_{name}_code' for name in q5_items],
    # –ø.6 ‚Äî —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –±–∏–Ω–∞—Ä–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
    *[f'q6_{name}' for name in q6_items],
    'q6_free_text',
    *[f'q6_{name}_any' for name in q6_items],
    # 7‚Äì10 + —Å–æ—Ü–∏–æ–¥–µ–º + —Å–æ–≥–ª–∞—Å–∏–µ
    'q7_any_dreams', 'q8_2025', 'q9_5y', 'q10_10_20y',
    'sex', 'age', 'edu', 'sector', 'family', 'kids', 'living', 'locality', 'consent'
]

# --------------------
# –£—Ç–∏–ª–∏—Ç—ã
# --------------------
def validate_multiselect(values, min_sel=None, max_sel=None):
    n = len(values)
    if min_sel is not None and n < min_sel:
        return False, f'–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º {min_sel}'
    if max_sel is not None and n > max_sel:
        return False, f'–º–æ–∂–Ω–æ –Ω–µ –±–æ–ª–µ–µ {max_sel}'
    return True, ''

def _valid_email(s):
    return re.match(r'^[^@\s]+@[^@\s]+\.[^@\s]+$', s) is not None

def score_block2(ans):
    yes, no = '–î–∞', '–ù–µ—Ç'
    extro_yes = {1,2,5,6,8,9,12,14,15}
    extro_no  = {3,11,16,18,20,21}
    otro_yes  = {7,10,17,22}
    otro_no   = {4,13,19}
    extro_score = sum(1 for i in extro_yes if ans.get(f'b2_{i}') == yes) + \
                  sum(1 for i in extro_no  if ans.get(f'b2_{i}') == no)
    otro_score  = sum(1 for i in otro_yes if ans.get(f'b2_{i}') == yes) + \
                  sum(1 for i in otro_no  if ans.get(f'b2_{i}') == no)

    if 0 <= extro_score <= 6:
        extro_class = '–∏–Ω—Ç—Ä–æ–≤–µ—Ä—Ç–Ω–æ—Å—Ç—å'
    elif 7 <= extro_score <= 8:
        extro_class = '–∞–º–±–∏–≤–µ—Ä—Ç–Ω–æ—Å—Ç—å'
    elif 9 <= extro_score <= 15:
        extro_class = '—ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç–Ω–æ—Å—Ç—å'
    else:
        extro_class = '–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ'

    if 5 <= otro_score <= 7:
        otro_class = '–æ—Ç—Ä–æ–≤–µ—Ä—Ç–Ω–æ—Å—Ç—å'
    else:
        otro_class = '–Ω–µ –≤—ã—Ä–∞–∂–µ–Ω–∞'
    return extro_score, extro_class, otro_score, otro_class

def orientations_counts_q1(selected_labels):
    idx_by_label = {lab: i+1 for i, lab in enumerate(q1_options)}
    selected_idx = {idx_by_label[l] for l in selected_labels if l in idx_by_label}
    adapt = {4,7,9,10,15,16,17}
    social = {3,8,13,14,19,20,21}
    indiv = {1,2,5,6,11,12,18}
    return len(selected_idx & adapt), len(selected_idx & social), len(selected_idx & indiv)

def stress_types_counts_q3(selected_labels):
    idx_by_label = {lab: i+1 for i, lab in enumerate(q3_options)}
    selected_idx = {idx_by_label[l] for l in selected_labels if l in idx_by_label}
    reliable = {4,5,6,7,9,13,16}
    anxious  = {1,3,8,17,18,19,21}
    avoidant = {2,10,11,12,14,15,20}
    return len(selected_idx & reliable), len(selected_idx & anxious), len(selected_idx & avoidant)

def append_to_sheet(headers, row_dict):
    existing = ws.get_all_values()
    if not existing:
        ws.append_row(headers, value_input_option='RAW')
    ws.append_row([row_dict.get(h, '') for h in headers], value_input_option='RAW')

# --------------------
# –¢–µ–∫—Å—Ç-–∏–Ω—Ç—Ä–æ
# --------------------
st.title('–ê–Ω–∫–µ—Ç–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è')
st.caption('–ü—Ä–æ–µ–∫—Ç–Ω–æ-—É—á–µ–±–Ω–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π, –®–∫–æ–ª–∞ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –§–ö–ò –ù–ò–£ –í–®–≠')
st.markdown(
    '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü—Ä–æ–µ–∫—Ç–Ω–æ-—É—á–µ–±–Ω–∞—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π –®–∫–æ–ª—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞ '
    '–∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö –∏–Ω–¥—É—Å—Ç—Ä–∏–π –ù–ò–£ –í–®–≠ –ø—Ä–æ–≤–æ–¥–∏—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –Ω–∞ –∞–Ω–∞–ª–∏–∑ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π '
    '–æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∏ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ—Å—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∞–Ω–∫–µ—Ç—ã (–æ–∫–æ–ª–æ 7‚Äì10 –º–∏–Ω—É—Ç). '
    '–ï—Å–ª–∏ –≤—ã –≥–æ—Ç–æ–≤—ã –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ —Ñ–æ–∫—É—Å-–≥—Ä—É–ø–ø –∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏ –æ—Ç –®–∫–æ–ª—ã '
    '–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π, —É–∫–∞–∂–∏—Ç–µ —Å–≤–æ–π —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –Ω–∏–∂–µ.\n\n'
    '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ä–æ—Å–∞ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Ç–æ–ª—å–∫–æ –≤ –æ–±–æ–±—â—ë–Ω–Ω–æ–º –≤–∏–¥–µ, –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–º—ë–Ω. '
    '–û—Ç–≤–µ—Ç—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç –æ—Å–æ–±—ã—Ö –∑–Ω–∞–Ω–∏–π.\n\n'
    '–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!'
)

# —Ç–∞–π–º–µ—Ä –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
if 't_start' not in st.session_state:
    st.session_state['t_start'] = time.time()

# --------------------
# –§–æ—Ä–º–∞
# --------------------
with st.form('survey', clear_on_submit=False):
    email = st.text_input('–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å (–ø–æ –∂–µ–ª–∞–Ω–∏—é, –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ —Ñ–æ–∫—É—Å-–≥—Ä—É–ø–ø—É)')

    st.markdown('---')
    st.subheader('1. –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç 3 –¥–æ 5 –Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤')
    q1_vals = st.multiselect('–û—Ç–º–µ—Ç—å—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã', q1_options)
    st.caption('–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –º–∏–Ω–∏–º—É–º 3, –º–∞–∫—Å–∏–º—É–º 5.')

    st.markdown('---')
    st.subheader('–ë–ª–æ–∫ 2. –ò–Ω—Ç—Ä–æ–≤–µ—Ä—Ç–Ω–æ—Å—Ç—å ‚Äì —ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç–Ω–æ—Å—Ç—å ‚Äì –æ—Ç—Ä–æ–≤–µ—Ä—Ç–Ω–æ—Å—Ç—å')
    st.caption('–û—Ç–≤–µ—á–∞–π—Ç–µ ¬´–î–∞¬ª –∏–ª–∏ ¬´–ù–µ—Ç¬ª.')
    b2_answers = {}
    for i in range(1, 23):
        b2_answers[f'b2_{i}'] = st.radio(f'{i}. {b2_text[i]}', ['–î–∞', '–ù–µ—Ç'], horizontal=True, key=f'k_b2_{i}')
    # –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–Ω–∏–º–∞–Ω–∏—è (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
    b2_attn = st.radio('–ö–æ–Ω—Ç—Ä–æ–ª—å –≤–Ω–∏–º–∞–Ω–∏—è: –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–î–∞¬ª –≤ —ç—Ç–æ–º –ø—É–Ω–∫—Ç–µ', ['–î–∞', '–ù–µ—Ç'], horizontal=True, key='k_b2_attn')

    st.markdown('---')
    st.subheader('3. –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–µ—Å—Å –∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å (–≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç 4 –¥–æ 7 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)')
    q3_vals = st.multiselect('–û—Ç–º–µ—Ç—å—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã', q3_options)
    st.caption('–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –º–∏–Ω–∏–º—É–º 4, –º–∞–∫—Å–∏–º—É–º 7.')

    st.markdown('---')
    st.subheader('4. ¬´–û–∫–∞–∑–∞–≤—à–∏—Å—å –≤ —Ç—Ä—É–¥–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏, —è‚Ä¶¬ª (–¥–æ 3 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)')
    q4_vals = st.multiselect('–ú–æ–∂–Ω–æ –¥–æ 3 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤', q4_options, max_selections=3)
    q4_free = st.text_area('–ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ ¬´–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª, –æ–ø–∏—à–∏—Ç–µ', '')

    st.markdown('---')
    st.subheader('5. –£—á–∞—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è—Ö?')
    st.caption('–û—Ç–º–µ—Ç—å—Ç–µ —á–∞—Å—Ç–æ—Ç—É.')
    q5 = {item: st.select_slider(item, options=FREQ3, value='–ù–∏–∫–æ–≥–¥–∞') for item in q5_items}
    q5_free_text = ''
    if q5.get('–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç') in ('–†–µ–≥—É–ª—è—Ä–Ω–æ', '–ò–Ω–æ–≥–¥–∞'):
        q5_free_text = st.text_input('–ü.5 ‚Äî –æ–ø–∏—à–∏—Ç–µ ¬´–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª')

    st.markdown('---')
    st.subheader('6. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥')
    st.caption('–®–∫–∞–ª–∞: -1 ‚Äî –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –∏–∑–±–µ–≥–∞—é; 0 ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª(–∞); 5 ‚Äî –æ—á–µ–Ω—å —á–∞—Å—Ç–æ.')
    q6 = {item: st.slider(item, min_value=-1, max_value=5, value=0) for item in q6_items}
    q6_free_text = ''
    if q6.get('–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç', 0) != 0:
        q6_free_text = st.text_input('–ü.6 ‚Äî –æ–ø–∏—à–∏—Ç–µ ¬´–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç¬ª')

    st.markdown('---')
    st.subheader('7‚Äì10. –ú–µ—á—Ç—ã –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã')
    q7 = st.radio('7. –ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –º–µ—á—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –±—ã —Ö–æ—Ç–µ–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å?', ['–î–ê', '–ù–ï–¢'], horizontal=True)
    q8 = st.text_area('8. –ö–∞–∫—É—é –º–µ—á—Ç—É —Ö–æ—Ç–µ–ª–∏ –±—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–æ –∫–æ–Ω—Ü–∞ 2025 –≥–æ–¥–∞?', '')
    q9 = st.text_area('9. –ö–∞–∫–∏–µ –º–µ—á—Ç—ã ‚Äî –≤ –±–ª–∏–∂–∞–π—à–∏–µ –ø—è—Ç—å –ª–µ—Ç?', '')
    q10 = st.text_area('10. –ö–∞–∫–∏–µ –º–µ—á—Ç—ã ‚Äî –≤ –±–ª–∏–∂–∞–π—à–∏–µ 10‚Äì20 –ª–µ—Ç?', '')

    st.markdown('---')
    st.subheader('–ù–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –≤–∞—Å')
    sex = st.radio('–ü–æ–ª', ['–ú—É–∂', '–ñ–µ–Ω'], horizontal=True)
    age = st.number_input('–í–æ–∑—Ä–∞—Å—Ç (–ø–æ–ª–Ω–æ–µ —á–∏—Å–ª–æ –ª–µ—Ç)', min_value=14, max_value=120, step=1)
    edu = st.selectbox('–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', [
        '–û—Å–Ω–æ–≤–Ω–æ–µ –æ–±—â–µ–µ (9 –∫–ª–∞—Å—Å–æ–≤)',
        '–°—Ä–µ–¥–Ω–µ–µ –æ–±—â–µ–µ (11 –∫–ª–∞—Å—Å–æ–≤)',
        '–°—Ä–µ–¥–Ω–µ–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ (–∫–æ–ª–ª–µ–¥–∂/—Ç–µ—Ö–Ω–∏–∫—É–º)',
        '–í—ã—Å—à–µ–µ I —Å—Ç–µ–ø–µ–Ω–∏ (–±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç)',
        '–í—ã—Å—à–µ–µ II —Å—Ç–µ–ø–µ–Ω–∏ (—Å–ø–µ—Ü–∏–∞–ª–∏—Ç–µ—Ç/–º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞)',
        '–í—ã—Å—à–µ–µ —Å —É—á—ë–Ω–æ–π —Å—Ç–µ–ø–µ–Ω—å—é'
    ])
    sector = st.selectbox('–°—Ñ–µ—Ä–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏', [
        '–†–∞–±–æ—á–∏–π',
        '–ò–Ω–∂–µ–Ω–µ—Ä–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ –Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏',
        '–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –≤ –Ω–µ–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π —Å—Ñ–µ—Ä–µ (—É—á–∏—Ç–µ–ª—å, –≤—Ä–∞—á, —Ä–∞–±–æ—Ç–Ω–∏–∫ –Ω–∞—É–∫–∏, –∫—É–ª—å—Ç—É—Ä—ã –∏ —Ç.–ø.)',
        '–†–∞–±–æ—Ç–Ω–∏–∫ —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–≥–æ –∞–ø–ø–∞—Ä–∞—Ç–∞',
        '–í–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏–π',
        '–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ—Ä–≥–∞–Ω–æ–≤ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–µ–ª',
        '–ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å',
        '–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä',
        '–£—á–∞—â–∏–π—Å—è, —Å—Ç—É–¥–µ–Ω—Ç',
        '–î–æ–º–æ—Ö–æ–∑—è–π–∫–∞',
        '–ù–µ —Ä–∞–±–æ—Ç–∞—é',
        '–î—Ä—É–≥–æ–µ'
    ])
    family = st.selectbox('–°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ', ['–ñ–µ–Ω–∞—Ç/–∑–∞–º—É–∂–µ–º', '–†–∞–∑–≤–µ–¥–µ–Ω(–∞)', '–í–¥–æ–≤–µ—Ü(–∞)', '–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ—Å—Ç–æ—è–ª(–∞) –≤ –±—Ä–∞–∫–µ'])
    kids = st.selectbox('–ù–∞–ª–∏—á–∏–µ –¥–µ—Ç–µ–π', [
        '–û–¥–∏–Ω —Ä–µ–±–µ–Ω–æ–∫', '–î–≤–∞ —Ä–µ–±–µ–Ω–∫–∞', '–¢—Ä–æ–µ –∏ –±–æ–ª–µ–µ –¥–µ—Ç–µ–π',
        '–î–µ—Ç–µ–π –Ω–µ—Ç, –Ω–æ –ø–ª–∞–Ω–∏—Ä—É—é –≤ –±–ª–∏–∂–∞–π—à–∏–µ —Ç—Ä–∏ –≥–æ–¥–∞', '–î–µ—Ç–µ–π –Ω–µ—Ç, –ø–æ–∫–∞ –Ω–µ –∑–∞–¥—É–º—ã–≤–∞–ª—Å—è(–∞—Å—å)'
    ])
    living = st.selectbox('–°–æ–≤–º–µ—Å—Ç–Ω–æ–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ', [
        '–ñ–∏–≤—É –≤ —Å–µ–º—å–µ —Ä–æ–¥–∏—Ç–µ–ª–µ–π –∏/–∏–ª–∏ —Å—Ç–∞—Ä—à–µ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è', '–ñ–∏–≤—É –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–µ–º—å–µ', '–ñ–∏–≤—É –æ—Ç–¥–µ–ª—å–Ω–æ'
    ])
    locality = st.selectbox('–ú–µ—Å—Ç–æ –∂–∏—Ç–µ–ª—å—Å—Ç–≤–∞', [
        '–°–≤–µ—Ä—Ö–∫—Ä—É–ø–Ω—ã–π –≥–æ—Ä–æ–¥ (>3 –º–ª–Ω)', '–ö—Ä—É–ø–Ω–µ–π—à–∏–π –≥–æ—Ä–æ–¥ (1‚Äì3 –º–ª–Ω)', '–ö—Ä—É–ø–Ω—ã–π –≥–æ—Ä–æ–¥ (250‚Äì1000 —Ç—ã—Å.)',
        '–ë–æ–ª—å—à–æ–π –≥–æ—Ä–æ–¥ (100‚Äì250 —Ç—ã—Å.)', '–°—Ä–µ–¥–Ω–∏–π –≥–æ—Ä–æ–¥ (50‚Äì100 —Ç—ã—Å.)', '–ú–∞–ª—ã–π –≥–æ—Ä–æ–¥ –∏/–∏–ª–∏ –ø–æ—Å–µ–ª–æ–∫ (<50 —Ç—ã—Å.)'
    ])
    consent = st.checkbox('–°–æ–≥–ª–∞—Å–µ–Ω(–Ω–∞) –Ω–∞ —É—á–∞—Å—Ç–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–≤–µ—Ç–æ–≤ –≤ –æ–±–æ–±—â—ë–Ω–Ω–æ–º –≤–∏–¥–µ')

    st.caption('–ù–∞–∂–∏–º–∞—è ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω—ã —Å —Ü–µ–ª—è–º–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–±–æ–±—â—ë–Ω–Ω–æ–º –≤–∏–¥–µ.')
    submitted = st.form_submit_button('–û—Ç–ø—Ä–∞–≤–∏—Ç—å')

# --------------------
# –°–∞–±–º–∏—Ç
# --------------------
if submitted:
    errors = []
    if email and not _valid_email(email):
        errors.append('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç e-mail.')
    ok1, msg1 = validate_multiselect(q1_vals, min_sel=3, max_sel=5)
    if not ok1:
        errors.append('–ë–ª–æ–∫ 1: ' + msg1)
    ok3, msg3 = validate_multiselect(q3_vals, min_sel=4, max_sel=7)
    if not ok3:
        errors.append('–ë–ª–æ–∫ 3: ' + msg3)
    missing_b2 = [i for i in range(1, 23) if b2_answers.get(f'b2_{i}') not in ('–î–∞', '–ù–µ—Ç')]
    if missing_b2:
        errors.append(f'–ë–ª–æ–∫ 2: –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã (–Ω–µ –æ—Ç–≤–µ—á–µ–Ω–æ: {len(missing_b2)})')
    if b2_attn != '–î–∞':
        errors.append('–ö–æ–Ω—Ç—Ä–æ–ª—å –≤–Ω–∏–º–∞–Ω–∏—è: –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–î–∞¬ª.')
    if not consent:
        errors.append('–ù—É–∂–Ω–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ —É—á–∞—Å—Ç–∏–µ.')

    if errors:
        for e in errors:
            st.error(e)
    else:
        response_id = str(uuid.uuid4())
        duration_sec = int(time.time() - st.session_state['t_start'])

        # –ø–æ–¥—Å—á—ë—Ç—ã
        extro_score, extro_class, otro_score, otro_class = score_block2(b2_answers)
        q1_adapt, q1_social, q1_indiv = orientations_counts_q1(q1_vals)
        q3_rel, q3_anx, q3_avo = stress_types_counts_q3(q3_vals)

        # —Å–±–æ—Ä —Å—Ç—Ä–æ–∫–∏
        row = {
            'response_id': response_id,
            'ts': datetime.utcnow().isoformat(timespec='seconds'),
            'duration_sec': duration_sec,
            'email': email or '',
            'q1_values': '; '.join(q1_vals),
            'q1_adaptation_cnt': q1_adapt,
            'q1_socialization_cnt': q1_social,
            'q1_individualization_cnt': q1_indiv,
            'b2_extro_score': extro_score,
            'b2_extro_class': extro_class,
            'b2_otro_score': otro_score,
            'b2_otro_class': otro_class,
            'q3_values': '; '.join(q3_vals),
            'q3_reliable_cnt': q3_rel,
            'q3_anxious_cnt': q3_anx,
            'q3_avoidant_cnt': q3_avo,
            'q4_values': '; '.join(q4_vals),
            'q4_free': q4_free,
        }

        # –ø.5: —á–∞—Å—Ç–æ—Ç—ã + –∫–æ–¥—ã
        for name, v in q5.items():
            row[f'q5_{name}'] = v
        row['q5_free_text'] = q5_free_text
        for name, v in q5.items():
            row[f'q5_{name}_code'] = MAP_Q5.get(v, '')

        # –ø.6: —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è + –±–∏–Ω–∞—Ä–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        for name, v in q6.items():
            row[f'q6_{name}'] = v
        row['q6_free_text'] = q6_free_text
        for name, v in q6.items():
            row[f'q6_{name}_any'] = 1 if v > 0 else 0

        # 7‚Äì10 + —Å–æ—Ü–∏–æ–¥–µ–º
        row.update({
            'q7_any_dreams': q7,
            'q8_2025': q8,
            'q9_5y': q9,
            'q10_10_20y': q10,
            'sex': sex,
            'age': age,
            'edu': edu,
            'sector': sector,
            'family': family,
            'kids': kids,
            'living': living,
            'locality': locality,
            'consent': 'yes' if consent else 'no'
        })

        try:
            append_to_sheet(HEADERS, row)
            st.success('–û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç. –°–ø–∞—Å–∏–±–æ!')
            st.info(
                f'–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: {extro_class} (–±–∞–ª–ª={extro_score}); '
                f'–æ—Ç—Ä–æ–≤–µ—Ä—Ç–Ω–æ—Å—Ç—å: {otro_class} (–±–∞–ª–ª={otro_score}). '
                f'–¶–µ–Ω–Ω–æ—Å—Ç–∏: –∞–¥–∞–ø—Ç–∞—Ü–∏—è={q1_adapt}, —Å–æ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è={q1_social}, –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–∏–∑–∞—Ü–∏—è={q1_indiv}.'
            )
        except Exception as e:
            st.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ Google Sheets: ' + str(e))
